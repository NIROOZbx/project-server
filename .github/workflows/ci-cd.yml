name: Ecommerce CI-CD Pipeline

on:
    push:
        branches:
            - main
jobs:
    build:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
            - name: Login to Docker Hub
              uses: docker/login-action@v3
              with:
                  username: ${{ secrets.DOCKER_USERNAME }}
                  password: ${{ secrets.DOCKER_PASSWORD }}

            - name: Build docker image
              run: docker build -t nirooz/jersey-hub .
            - name: Push image to docker hub
              run: docker push nirooz/jersey-hub:latest

    deploy:
        needs: build
        runs-on: self-hosted
        steps:
            - name: Pull docker image
              run: docker pull nirooz/jersey-hub:latest
            - name: Delete old container
              run: |
                docker stop go-app-container || true
                docker rm go-app-container || true
            - name: Run docker container
              run: |
                docker run -d \
                -p 8080:8080 \
                --name go-app-container \
                --restart always \
                -e DSN="${{ secrets.DSN }}" \
                -e REDIS_URL="${{ secrets.REDIS_URL }}" \
                -e JWT_ACCESS_SECRET="${{ secrets.JWT_ACCESS_SECRET }}" \
                -e JWT_REFRESH_SECRET="${{ secrets.JWT_REFRESH_SECRET }}" \
                -e SENGRID_API_KEY="${{ secrets.SENGRID_API_KEY }}" \
                -e SENDER_NAME="${{ secrets.SENDER_NAME }}" \
                -e SENDER_MAIL="${{ secrets.SENDER_MAIL }}" \
                -e CLOUDINARY_URL="${{ secrets.CLOUDINARY_URL }}" \
                -e JWT_RESET_SECRET="${{ secrets.JWT_RESET_SECRET }}" \
                nirooz/jersey-hub:latest
    


